// Prevent multiple executions
if (typeof window.clothingLoaded === 'undefined') {
    window.clothingLoaded = true;
    
    const clothingItems = [

"Abibas Keezy Foam shoes",
"Abibas Marquee Boost Lows shoes",
"Abibas pants",
"Abibas Pezy Boost 700 V3 Alvah shoes",
"Abibas Pro Bounce 2019 Lows shoes",
"Abibas sport pants",
"Abibas suit",
"Abibas sweatpants",
"accessory",
"Acic Gel Kayano sneakers",
"Air Bior pullover sweater",
"AK-47 chain",
"Alaska winter jacket",
"Alastor McQueen oversized shoes",
"alien with neon eyes mask",
"Alvin Lein backpack skin",
"Alvin Lein pants",
"Alvin Lein set",
"Alvin Lein T-shirt",
"anime mask",
"Anti Social Club hoodie",
"bitkin handbag skin",
"Arm Pangel jacket",
"assassins mask",
"backpack skin",
"backpack with a cat skin",
"bandana mask",
"Bans sneakers",
"baseball mask",
"bear backpack skin",
"belted pants",
"Bersace set",
"Bersace trousers",
"Bigness mask",
"biohazard backpack skin",
"Bior backpack skin",
"Bior pants",
"black voron shoulder accessory",
"black jacket with yellow trim",
"blob longsleeve top",
"Bomber jacket with glowing elements",
"boxing gloves",
"boxing helmet",
"bracelet",
"branded CDG T-shirt",
"branded insulated hoodie",
"branded longsleeve",
"branded Molo T-shirt",
"branded monochrome T-shirt",
"branded pants with bunny detail",
"branded T-shirt",
"branded headband",
"bright hoodie",
"bright StarWars hoodie",
"bright StarWars set",
"bright StarWars trousers",
"bright trousers",
"CAP T-shirt",
"carnival mask",
"Casual neon helmet",
"Casual neon torso",
"cat mask",
"CDG branded T-shirt",
"chain",
"chain around the body accessory",
"chain lost treasure neon accessory",
"chain with spikes backpack skin",
"chain with star pendant",
"checkered Pans sneakers",
"Christmas tree mask",
"classic denim jacket",
"classic Lui Vi backpack skin",
"clown chain",
"clown mask",
"cloud backpack skin",
"collection 2022 T-shirt",
"colored pants",
"cow backpack skin",
"cowgirl hat",
"Craft Munk mask",
"cropp collection T-shirt",
"cross backpack skin",
"Cupids crown",
"Curry Flow 8 sneakers",
"cute bear backpack skin",
"deer antler accessory",
"deer antlers with a red nose accessory",
"demon backpack skin",
"demon mask",
"Denim jacket",
"Lui Vi desert scarf mask",
"desert scarf mask",
"devil mask",
"Domo backpack skin",
"double pockets backpack skin",
"duck backpack skin",
"duffel bag skin",
"earrings",
"eagle necklace",
"earphones with a heart",
"el primo corazon krawl on the shoulder accessory",
"emoji mask",
"Essential brand suit top",
"Essential branded pants",
"evil mask",
"exclusive T-shirt",
"exotic mask",
"fancy bear backpack skin.",
"fashionista scarf mask",
"flying bear on the shoulder accessory",
"fluorescent cat ears",
"fox mask",
"fur coat without a hood",
"G backpack skin",
"glasses with glowing snow",
"gloves",
"glowing face scarf mask",
"glowing nails",
"gold Kolex watch with black dial",
"gold Kolex watch with rainbow bezels",
"gothic hoodie with neon eyes",
"silver Kolex watch with rainbow bezels",
"gorilla mask",
"Grand chain",
"Grada set",
"Grand RP collection hoodie",
"Grand RP collection pants",
"Grand RP collection set",
"Grand RP collection T-shirt",
"Ground Mordan 4 Retro Laser 30th shoes",
"Gussi shorts",
"half-glowing pants",
"hamster on the shoulder accessory",
"handbag backpack skin",
"handkerchief mask",
"hearts Pride glasses",
"heart backpack skin",
"heart with wings backpack skin",
"Hilipp Lein T-shirt",
"hippy bear backpack skin",
"human backpack skin",
"insulated personal pants",
"Jacket",
"Jacket with a hood",
"jacket with blue luminous trim",
"jacket with green luminous trim",
"jacket with pink luminous trim",
"jacket with red luminous trim",
"jacket with T-shirt",
"jacket with turquoise luminous trim",
"jacket with white luminous trim",
"Jason blue mask",
"jolly bear backpack skin",
"Juice Wrld Vlone T-shirt",
"Kasio G-Shock watch",
"Kazer headphones",
"Mickeys Christmas backpack skin",
"modern heeled boots",
"Keezy Boost shoes",
"Khampion pants",
"Khampion set",
"Khampion T-shirt",
"Khanel pants",
"Khanel set",
"Khanel top",
"kitsune mask",
"Kolex 2 watch",
"Kolex watch",
"Kupreme backpack skin",
"Kupreme set",
"Kupreme T-shirt",
"Lacoste T-shirt",
"leather school backpack skin",
"leather gothic pants",
"leon krawl on the shoulder accessory",
"Love costume",
"lovely bird egg on the shoulder accessory",
"Lui Vi shorts",
"Lui Vi backpack skin",
"Lui Vi jacket",
"Lui Vi pants",
"Lui Vi shoulder backpack skin.",
"Lui Vi set",
"Lui Vi sweatshirt",
"Lui Vi T-shirt",
"Lui Vi top",
"luminous Bendi pants",
"luminous Bendi set",
"luminous branded pants with bunny detail",
"luminous Grand RP trousers",
"luminous head bag mask",
"luminous LM Playboy mask",
"luminous LM Playboy set",
"luminous LM Playboy trousers",
"luminous OFF pants",
"luminous OFF set",
"luminous shoes",
"luminous trousers",
"LUV backpack with wings skin",
"maliky hoodie",
"maliky T-shirt",
"mask",
"Mask Broken",
"mask made of clips on a chain",
"Mickey Mouse pants",
"Mickey Mouse T-shirt",
"Mikachu hoodie",
"Mikachu T-shirt",
"mini-bear backpack skin",
"mix collection T-shirt",
"monkey boss mask",
"monkey mask",
"Mordan 1 shoes",
"Mordan 6 shoes",
"Muci backpack skin",
"Muci branded flip-flops",
"Muci hoodie",
"Muci hoodie with a snake",
"Muci Not Fake hoodie",
"Muci pants",
"Muci sweatshirt",
"Muci trousers",
"multi-colored Pans sneakers",
"Murberry pants",
"N.E.S.A. pants",
"N.E.S.A. T-shirt",
"navel piercing accessory",
"neck scarf accessory",
"necklace",
"neon horns with spikes",
"neon Lui Vi pants",
"neon pants",
"neon rabbit ears",
"neon shoes",
"neon torso",
"New Balance trousers",
"new fashionable joggers",
"New Years Eve costume",
"Nik Huarache shoes",
"Nik shorts with leggings",
"Niki backpack skin",
"Niki Ground Porce One new collection shoes",
"Niki mask",
"Niki new collection hoodie",
"Niki new collection pants",
"Niki Shox shoes",
"Niki tech fleece pants",
"Niki tech top",
"Niki track suit pants",
"Niki track suit top",
"Niki Uptempo shoes",
"Niki Zoom Freak 1 Multi-Color shoes",
"old summer shorts",
"one-colour CAP T-shirt",
"owl mask",
"owl on the shoulder accessory",
"panama hat",
"pants",
"pants split",
"pants with belt",
"Pans sneakers",
"penguin mask",
"Pezy Boost shoes",
"piggy keychain backpack skin",
"pig mask",
"pixel glasses",
"plain jacket with sweater",
"plaid bunny backpack skin",
"Polo Kinder T-shirt",
"pullover with long sleeve",
"purge mask",
"rabbit ears",
"raccoon mask",
"ragged jeans",
"raptor mask",
"raven mask",
"red sneakers",
"red stocking mask",
"reindeer mask",
"RGB neon shoes",
"Rick and Morty trendy jacket",
"Rick Ownis X Dr. Martian boots",
"robot human mask",
"robot mask",
"Rocs",
"rooster mask",
"sneakers",
"S cargo pants",
"sad hare backpack skin",
"samurai mask",
"Santa Claus mask",
"saruko neon mask",
"satanic wings",
"Sashmello mask",
"scary chicken backpack skin",
"scary turtleneck T-shirt",
"scarf",
"shamanic mask",
"shark backpack skin",
"shirt new",
"shiny deer antler headband accessory",
"shoes",
"short pullover",
"shorts",
"sporty boots for women",
"Simpsons T-shirt",
"six-tailed fox on the shoulder accessory",
"skater jeans",
"skeleton cat backpack skin",
"skeleton cheetah plush backpack skin",
"skeleton king mask",
"skinny jacket",
"skull backpack skin",
"snowboarders mask",
"snowflake glasses",
"snowman mask",
"spider pants",
"sports mask",
"sports top",
"Spring Set",
"star bunny backpack skin",
"stealthy mask",
"ston islan classic sport pants",
"stonislan pants",
"strawberry backpack skin",
"strong chicken on the shoulder accessory",
"stylish suit",
"Summer bra",
"summer collection T-shirt",
"summer top",
"summer voyage shorts",
"Sweatshirt",
"swordmen pants",
"T-shirt",
"The West Pace jacket",
"tie",
"tight mask",
"tied scarf mask",
"toothy mask",
"toothless dragon on the shoulder accessory",
"top",
"top 2 outerwear",
"top with chains",
"topic pok",
"trainers",
"trendy jacket",
"trending shark head hat",
"Tron helmet",
"Tron pants",
"Tron set",
"Tron shoes",
"trousers",
"Tsum collection T-shirt",
"TV-head mask",
"Up-Green Keezy Boost shoes",
"Up-Green Pezy Boost shoes",
"Up-Green sweatshirt",
"Valenciaga pants",
"Valenciaga set",
"Valenciaga Track shoes",
"valentines cat backpack skin",
"Venom backpack skin",
"VIN T-shirt",
"vintage Abibas Olympic Jerseys",
"Volex 2 watch",
"Volex watch",
"Watch Me sweater",
"wedding dress",
"white Lui Vi desert scarf mask with multi-colored top",
"tapered classic turtleneck",
"wide print soccer T-shirt",
"wide printed football T-shirt ",
"winter collection dress",
"wristband accessory",
"zipper pants",
"Abibas leggings",
"Bandana top",
"Barberry corset dress",
"beads accessory",
"Body wraps kill top",
"branded colourful T-shirt",
"Calligraphy dress",
"Collection 5 top",
"Corset top",
"Day dress",
"Dress",
"Dress with cutout",
"Faution top",
"Hoodie",
"Jeans",
"Kupreme dress",
"Long brand T-shirt",
"low dress",
"luminous LM Playboy jacket",
"luminous LM Playboy sweatshirt",
"luminous LM Playboy T-shirt",
"luminous LM Playboy top",
"luminous T-shirt",
"Muci shorts",
"Niki new collection set",
"open olympics top",
"Onelove chain",
"Panel pants",
"Skirt",
"Skirt with tights",
"swimming trunks",
"Tall boots",
"Tron torso",
"Valenciaga T-shirt",

];


const clothingColors = ["luminous", "red", "blue", "green", "black", "white", "yellow", "purple", "orange", "pink", "gray"];
const clothingTypes = Array.from({ length: 30 }, (_, i) => `type ${i + 1}`);
const clothingGenders = ["", "for men", "for women"];


class ClothingForm {
    constructor() {
        this.state = {
            type: 'Buying', // Default transaction type
            isTrading: false,
            items: [{}, {}, {}], // Array of objects to hold item details
            activeItemCount: 1,
            useInBulk: false,
            useRespectively: false
        };

        try {
            this.initializeElements();
            this.attachEventListeners();
            this.updateUI(); // Initial UI update
            this.updatePreview(); // Initial preview update
        } catch (error) {
            console.error('Error initializing ClothingForm:', error);
        }
    }

    initializeElements() {
        try {
            this.form = document.getElementById('clothingForm');
            this.clothingItemsContainer = document.getElementById('clothingItemsContainer');
            this.clothingPricesContainer = document.getElementById('clothingPricesContainer');
            this.clothingOutput = document.getElementById('clothing-output');
            this.clothingItemCount = document.getElementById('clothingItemCount');
            this.clothingItemsTitle = document.getElementById('clothingItemsTitle');
            this.clothingRespectivelyCheck = document.getElementById('clothingRespectivelyCheck');
            this.clothingItemControls = document.getElementById('clothingItemControls');
            this.clothingInBulkInput = document.getElementById('clothingInBulkOption');
            this.clothingInBulkLabel = document.querySelector('label[for="clothingInBulkOption"]');
            this.clothingTradingCheckbox = document.getElementById('clothing-trading');
            this.addClothingItemBtn = document.getElementById('addClothingItem');
            this.removeClothingItemBtn = document.getElementById('removeClothingItem');
            this.clothingSubmitBtn = document.getElementById('clothing-submit-btn');
            this.clothingCopyBtn = document.getElementById('clothing-copy-btn');
            
            // Check if essential elements exist
            if (!this.clothingItemsContainer || !this.clothingPricesContainer || !this.clothingOutput) {
                console.error('Essential clothing form elements not found');
                return;
            }
        } catch (error) {
            console.error('Error in initializeElements:', error);
        }
    }

    attachEventListeners() {
        // Transaction Type Radio Buttons (handled by inline script, listen for change)
        document.querySelectorAll('input[name="clothing-transaction"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.state.type = e.target.value;
                this.updatePreview();
            });
        });

        // Trading Option Checkbox
        if (this.clothingTradingCheckbox) {
            this.clothingTradingCheckbox.addEventListener('change', (e) => {
                this.state.isTrading = e.target.checked;
                 // For trading, we typically have two specific slots: "Your item" and "Wanted item"
                 // We'll simplify this for clothing to just indicate trading,
                 // but we can keep the ability to list up to 3 items if the user desires.
                 // Let's stick to the "up to 3 items" requirement, but adjust the title.
                this.updateUI();
                this.updatePreview();
            });
        }


        // Add/Remove Item Buttons
        if (this.addClothingItemBtn) {
            this.addClothingItemBtn.addEventListener('click', () => this.addClothingItem());
        }
        if (this.removeClothingItemBtn) {
            this.removeClothingItemBtn.addEventListener('click', () => this.removeClothingItem());
        }

        // In Bulk Checkbox (handled by inline script, listen for change)
        if (this.clothingInBulkInput) {
             this.clothingInBulkInput.addEventListener('change', (e) => {
                 this.state.useInBulk = e.target.checked;
                 this.updatePreview();
             });
        }


        // Respectively Checkbox
        if (this.clothingRespectivelyCheck) {
            this.clothingRespectivelyCheck.addEventListener('change', (e) => {
                this.state.useRespectively = e.target.checked;
                this.updatePreview();
            });
        }

        // Submit and Copy Buttons
        if (this.clothingSubmitBtn) {
            this.clothingSubmitBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.updatePreview();
            });
        }
        if (this.clothingCopyBtn) {
            this.clothingCopyBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.handleCopy();
            });
        }

        // Reset Button
        const clothingResetBtn = document.getElementById('clothing-reset-btn');
        if (clothingResetBtn) {
            clothingResetBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.resetForm();
            });
        }

        // Initial active state for transaction type radio buttons on load
        const initialTransactionType = document.querySelector('input[name="clothing-transaction"]:checked')?.value || 'Buying';
        this.state.type = initialTransactionType;
        const initialTradingState = this.clothingTradingCheckbox?.checked || false;
        this.state.isTrading = initialTradingState;

    }

    addClothingItem() {
        if (this.state.activeItemCount < 3) {
            this.state.activeItemCount++;
            this.state.items[this.state.activeItemCount - 1] = {}; // Initialize new item state
            this.updateUI();
            this.updatePreview();
        }
    }

    removeClothingItem() {
        if (this.state.activeItemCount > 1) {
            // Clear state for the item being removed
            this.state.items[this.state.activeItemCount - 1] = {};
            this.state.activeItemCount--;
            this.updateUI();
            this.updatePreview();
        }
    }

    createClothingInputGroup(index) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'clothing-item-group mb-3 p-3 border rounded bg-light'; // Added some styling

        const nameLabel = document.createElement('label');
        nameLabel.className = 'form-label';
        nameLabel.innerHTML = `<i class="fas fa-tags"></i> Clothing Name:`;
        itemDiv.appendChild(nameLabel);

        const nameInputGroup = document.createElement('div');
        nameInputGroup.className = 'position-relative'; // For suggestions positioning
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'form-control clothing-name-input';
        nameInput.placeholder = this.state.isTrading && index === 0 ? 'Your clothing item' : (this.state.isTrading && index === 1 ? 'Wanted clothing item' : `Clothing Name ${index + 1}`);
        nameInput.value = this.state.items[index].name || ''; // Populate from state

        const nameSuggestionsDiv = document.createElement('div');
        nameSuggestionsDiv.className = 'suggestion-box'; // Use existing suggestion box styling

        nameInputGroup.appendChild(nameInput);
        nameInputGroup.appendChild(nameSuggestionsDiv);
        itemDiv.appendChild(nameInputGroup);

        // Autocomplete logic for this specific input
        nameInput.addEventListener('input', () => {
            this.handleClothingNameInput(nameInput, nameSuggestionsDiv, index);
        });
         nameInput.addEventListener('focus', () => {
             if (nameInput.value) {
                 this.handleClothingNameInput(nameInput, nameSuggestionsDiv, index);
             }
         });
        nameInput.addEventListener('blur', () => {
            setTimeout(() => {
                nameSuggestionsDiv.style.display = 'none';
            }, 100);
        });


        const colorLabel = document.createElement('label');
        colorLabel.className = 'form-label mt-3';
        colorLabel.innerHTML = `<i class="fas fa-fill-drip"></i> Color:`;
        itemDiv.appendChild(colorLabel);

        const colorSelect = document.createElement('select');
        colorSelect.className = 'form-select clothing-color-select';
        colorSelect.innerHTML = '<option value="">Select a color</option>';
        clothingColors.forEach(color => {
            const option = document.createElement('option');
            option.value = color;
            option.textContent = color ? color.charAt(0).toUpperCase() + color.slice(1) : 'Select a color';
            colorSelect.appendChild(option);
        });
         colorSelect.value = this.state.items[index].color || ''; // Populate from state
        colorSelect.addEventListener('change', (e) => {
            this.state.items[index].color = e.target.value;
            this.updatePreview();
        });
        itemDiv.appendChild(colorSelect);

        const typeLabel = document.createElement('label');
        typeLabel.className = 'form-label mt-3';
        typeLabel.innerHTML = `<i class="fas fa-list-alt"></i> Type:`;
        itemDiv.appendChild(typeLabel);

        const typeSelect = document.createElement('select');
        typeSelect.className = 'form-select clothing-type-select';
        typeSelect.innerHTML = '<option value="">Select a type</option>';
        clothingTypes.forEach(type => {
             const option = document.createElement('option');
             option.value = ` of ${type}`; // Value includes " of " for output formatting
             option.textContent = type;
             // CORRECTED: Use typeSelect to append the option
             typeSelect.appendChild(option);
         });
         typeSelect.value = this.state.items[index].type || ''; // Populate from state
        typeSelect.addEventListener('change', (e) => {
            this.state.items[index].type = e.target.value;
            this.updatePreview();
        });
        itemDiv.appendChild(typeSelect);

        const genderLabel = document.createElement('label');
        genderLabel.className = 'form-label mt-3';
        genderLabel.innerHTML = `<i class="fas fa-venus-mars"></i> Gender:`;
        itemDiv.appendChild(genderLabel);

        const genderRadioGroup = document.createElement('div');
        genderRadioGroup.className = 'd-flex gap-4';
        clothingGenders.forEach(gender => {
            const formCheck = document.createElement('div');
            formCheck.className = 'form-check';
            const radioInput = document.createElement('input');
            radioInput.type = 'radio';
            radioInput.className = 'form-check-input clothing-gender-radio';
            radioInput.name = `clothing-gender-${index}`; // Unique name for each item
            radioInput.value = gender;
            radioInput.id = `clothing-gender-${index}-${gender.replace(/\s+/g, '-') || 'any'}`; // Unique ID

            const radioLabel = document.createElement('label');
            radioLabel.className = 'form-check-label';
            radioLabel.htmlFor = radioInput.id;
            radioLabel.textContent = gender || 'Any';

             if (this.state.items[index].gender === gender) {
                 radioInput.checked = true;
             }
             if (!this.state.items[index].gender && gender === "") { // Default to 'Any' if no gender in state
                  radioInput.checked = true;
             }


            radioInput.addEventListener('change', (e) => {
                this.state.items[index].gender = e.target.value;
                this.updatePreview();
            });

            formCheck.appendChild(radioInput);
            formCheck.appendChild(radioLabel);
            genderRadioGroup.appendChild(formCheck);
        });
        itemDiv.appendChild(genderRadioGroup);


         const quantityLabel = document.createElement('label');
         quantityLabel.className = 'form-label mt-3';
         quantityLabel.innerHTML = `<i class="fas fa-sort-numeric-up"></i> Quantity (Optional):`;
         itemDiv.appendChild(quantityLabel);

         const quantityInput = document.createElement('input');
         quantityInput.type = 'number';
         quantityInput.className = 'form-control clothing-quantity-input';
         quantityInput.placeholder = 'e.g., 5';
         quantityInput.min = '1';
         quantityInput.value = this.state.items[index].quantity || ''; // Populate from state

         quantityInput.addEventListener('input', (e) => {
             this.state.items[index].quantity = e.target.value;
             this.updatePreview();
         });
         itemDiv.appendChild(quantityInput);

         const pluralCheckLabel = document.createElement('label');
         pluralCheckLabel.className = 'checkbox-button-label mt-2';
         pluralCheckLabel.innerHTML = `<input type="checkbox" id="clothingPluralS${index}" class="d-none"> Add "S"`;

         const pluralInput = pluralCheckLabel.querySelector('input[type="checkbox"]');
         pluralInput.checked = this.state.items[index].usePluralS || false;
         if (pluralInput.checked) pluralCheckLabel.classList.add('active');

         pluralInput.addEventListener('change', (e) => {
             this.state.items[index].usePluralS = e.target.checked;
             if (e.target.checked) pluralCheckLabel.classList.add('active');
             else pluralCheckLabel.classList.remove('active');
             this.updatePreview();
         });
          pluralCheckLabel.addEventListener('click', (e) => {
              e.preventDefault();
              pluralInput.checked = !pluralInput.checked;
              pluralInput.dispatchEvent(new Event('change'));
         });

         itemDiv.appendChild(pluralCheckLabel);


        return itemDiv;
    }

    createClothingPriceInputGroup(index) {
        const priceDiv = document.createElement('div');
        priceDiv.className = 'clothing-price-group mb-3';

        const priceLabel = document.createElement('label');
        priceLabel.className = 'form-label';
        priceLabel.innerHTML = `<i class="fas fa-dollar-sign"></i> Price/Budget for Item ${index + 1}:`;
        priceDiv.appendChild(priceLabel);

        const priceInputGroup = document.createElement('div');
        priceInputGroup.className = 'input-group';

        const span = document.createElement('span');
        span.className = 'input-group-text';
        span.innerHTML = '<i class="fas fa-dollar-sign"></i>';

        const priceInput = document.createElement('input');
        priceInput.type = 'text';
        priceInput.className = 'form-control clothing-price-input';
        priceInput.placeholder = 'e.g. 400000 or 2M';
        priceInput.value = this.state.items[index].price || ''; // Populate from state

        priceInput.addEventListener('input', (e) => {
            this.state.items[index].price = e.target.value;
            // Automatically toggle 'respectively' if 2 or more items are active
            if (this.state.activeItemCount >= 2) {
                const respectivelyInput = this.clothingRespectivelyCheck.querySelector('input[type="checkbox"]');
                if (respectivelyInput && !respectivelyInput.checked) {
                    respectivelyInput.checked = true;
                    // Manually trigger change to update state and UI
                    respectivelyInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
            this.updatePreview();
        });

        priceInputGroup.appendChild(span);
        priceInputGroup.appendChild(priceInput);

        const eachCol = document.createElement('div');
        eachCol.className = 'col-auto d-flex align-items-center';

        const eachCheckLabel = document.createElement('label');
        eachCheckLabel.className = 'checkbox-button-label ms-2';
        eachCheckLabel.innerHTML = `<input type="checkbox" id="clothingEach${index}" class="d-none"> Each`;

        const eachInput = eachCheckLabel.querySelector('input[type="checkbox"]');
        eachInput.checked = this.state.items[index].useEach || false;
         if (eachInput.checked) eachCheckLabel.classList.add('active');

        eachInput.addEventListener('change', (e) => {
            this.state.items[index].useEach = e.target.checked;
             if (e.target.checked) eachCheckLabel.classList.add('active');
             else eachCheckLabel.classList.remove('active');
            this.updatePreview();
        });
         eachCheckLabel.addEventListener('click', (e) => {
              e.preventDefault();
              eachInput.checked = !eachInput.checked;
              eachInput.dispatchEvent(new Event('change'));
         });

        eachCol.appendChild(eachCheckLabel);

        priceInputGroup.appendChild(eachCol); // Append Each checkbox within the input group


        priceDiv.appendChild(priceInputGroup);
        return priceDiv;
    }


    handleClothingNameInput(inputElement, suggestionsBox, index) {
        const value = inputElement.value.toLowerCase();
        suggestionsBox.innerHTML = ''; // Clear previous suggestions

        if (value) {
            const matchingItems = clothingItems.filter(item =>
                item.toLowerCase().includes(value)
            );

            if (matchingItems.length > 0) {
                suggestionsBox.style.display = 'block';
                matchingItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = item;
                    div.addEventListener('mousedown', (e) => { // Use mousedown
                        e.preventDefault();
                        inputElement.value = item;
                        this.state.items[index].name = item; // Update state
                        suggestionsBox.style.display = 'none';
                        this.updatePreview(); // Update preview after selection
                    });
                    suggestionsBox.appendChild(div);
                });
            } else {
                suggestionsBox.style.display = 'none';
             this.state.items[index].name = ''; // Clear name in state if input is cleared
             this.updatePreview(); // Update preview when input is cleared
            }
        } else {
            suggestionsBox.style.display = 'none';
             this.state.items[index].name = ''; // Clear name in state if input is cleared
             this.updatePreview(); // Update preview when input is cleared
        }
    }


    updateUI() {
        try {
            if (!this.clothingItemsContainer || !this.clothingPricesContainer) {
                console.error('Clothing containers not found');
                return;
            }
            
            this.clothingItemsContainer.innerHTML = '';
            this.clothingPricesContainer.innerHTML = '';

            const count = this.state.activeItemCount;
            for (let i = 0; i < count; i++) {
                this.clothingItemsContainer.appendChild(this.createClothingInputGroup(i));
                // Only add price input if not trading or for the first item if trading (simplified for clothing)
                 // Let's add price inputs for all active items regardless of trading for now
                this.clothingPricesContainer.appendChild(this.createClothingPriceInputGroup(i));
            }

            if (this.clothingItemCount) {
                this.clothingItemCount.textContent = `${this.state.activeItemCount} of 3`;
            }
            if (this.addClothingItemBtn) {
                this.addClothingItemBtn.disabled = this.state.activeItemCount >= 3;
            }
            if (this.removeClothingItemBtn) {
                this.removeClothingItemBtn.disabled = this.state.activeItemCount <= 1;
            }

            // Show/hide respectively checkbox based on active item count
            if (this.clothingRespectivelyCheck) {
                this.clothingRespectivelyCheck.classList.toggle('d-none', this.state.activeItemCount <= 1);
                // If it becomes visible, check if it should be auto-checked
                if (this.state.activeItemCount >= 2) {
                    const respectivelyInput = this.clothingRespectivelyCheck.querySelector('input[type="checkbox"]');
                    if (respectivelyInput) {
                        respectivelyInput.checked = true;
                        this.state.useRespectively = true;
                    }
                }
            } else {
                this.state.useRespectively = false;
            }

             // Hide 'Each' checkbox if trading is selected
             document.querySelectorAll('.clothing-price-group .checkbox-button-label').forEach(label => {
                  label.style.display = this.state.isTrading ? 'none' : 'inline-flex';
             });
             // If trading is selected, ensure useEach states are false in state
              if (this.state.isTrading) {
                  this.state.items.forEach(item => item.useEach = false);
                  // No need to manually remove active classes here as updateUI recreates elements
              }

             // Hide 'Quantity' and 'Add S' if trading is selected (adjusting based on standard clothing ads)
             document.querySelectorAll('.clothing-item-group .clothing-quantity-input, .clothing-item-group .checkbox-button-label').forEach(element => {
                  element.style.display = this.state.isTrading ? 'none' : ''; // Use empty string to revert to default display
             });
             // If trading, clear quantity and set usePluralS to false in state
             if (this.state.isTrading) {
                 this.state.items.forEach(item => {
                     item.quantity = '';
                     item.usePluralS = false;
                 });
             }
        } catch (error) {
            console.error('Error in updateUI:', error);
        }
    }

    // Format price function for clothing ads (Returns formatted string with $)
    formatClothingPrice(price) {
        if (!price) return 'Negotiable'; // Return "Negotiable" if price is empty

        let cleanPrice = price.toString().toLowerCase().replace(/[^0-9km.]/g, '');
        let numericValue;

        if (cleanPrice.includes('k')) {
            numericValue = parseFloat(cleanPrice.replace('k', '')) * 1000;
            if (!isNaN(numericValue)) {
                // Replace commas with periods in the formatted output, add $
                return `$${numericValue.toLocaleString('en-US', { minimumFractionDigits: 0 }).replace(/,/g, '.')}`;
            }
        } else if (cleanPrice.includes('m')) {
             numericValue = parseFloat(cleanPrice.replace('m', '')) * 1000000;
             if (!isNaN(numericValue)) {
                  // Format millions: no decimal if whole number, one decimal otherwise, add $ and " Million"
                  const formattedNum = numericValue / 1000000;
                  return `$${formattedNum % 1 === 0 ? formattedNum.toFixed(0) : formattedNum.toFixed(1)} Million`;
             }
        } else {
            numericValue = parseFloat(cleanPrice);
            if (!isNaN(numericValue)) {
                // Replace commas with periods in the formatted output, add $
                return `$${numericValue.toLocaleString('en-US', { minimumFractionDigits: 0 }).replace(/,/g, '.')}`;
            }
        }

        return 'Negotiable'; // Return "Negotiable" for invalid input
    }

    formatClothingAd() {
        const { type, isTrading, items, useInBulk, useRespectively, activeItemCount } = this.state;

        const validItems = items.slice(0, activeItemCount).filter(item => item.name && item.name.trim());

        if (validItems.length === 0) {
             // If no items are entered, provide a default prompt
             return 'Your clothing advertisement will appear here...';
        }

        const capitalizedType = type.charAt(0).toUpperCase() + type.slice(1);

        let itemsText = validItems.map((item, index) => {
            const { name, color, type, gender, quantity, usePluralS } = item;
            const parts = [];

            if (quantity && !isTrading) { // Only add quantity if not trading
                 parts.push(quantity.trim());
            }

            if (color && color.trim()) {
                parts.push(color.trim());
            }
            if (name && name.trim()) {
                 let formattedName = name.trim();
                  // MODIFIED: Add 's' if 'Add S' is checked and name doesn't end in 's' (regardless of quantity)
                  if (usePluralS && !formattedName.toLowerCase().endsWith('s')) {
                      formattedName += 's';
                  }
                 parts.push(formattedName);
            }
            if (type && type.trim()) {
                parts.push(type.trim());
            }
            if (gender && gender.trim() && !isTrading) { // Only add gender if not trading
                 parts.push(gender.trim());
            }

            const itemText = parts.join(' ');
            
            // Add "a" article for single items when not trading and not plural
            if (!isTrading && !quantity && !usePluralS && !itemText.toLowerCase().endsWith('s')) {
                // Check if item name already starts with "a " (like "a pet dog")
                // Also, do not add 'a' for inherently plural items or multi-word names
                const pluralClothing = ['pants', 'jeans', 'shorts', 'trousers', 'leggings', 'sweatpants', 'boxers', 'briefs', 'joggers'];
                const lowerItem = itemText.toLowerCase();
                const isMultiWord = lowerItem.trim().split(/\s+/).length > 1;
                if (!itemText.toLowerCase().startsWith('a ') && !pluralClothing.some(word => lowerItem.includes(word)) && !isMultiWord) {
                    return `a ${itemText}`;
                }
            }

            return itemText;
        }).filter(text => text.trim());

        if (itemsText.length > 2) {
            const allButLast = itemsText.slice(0, -1).join(', ');
            const last = itemsText[itemsText.length - 1];
            itemsText = `${allButLast} and ${last}`;
        } else {
            itemsText = itemsText.join(' and ');
        }

        let output = `${capitalizedType}${isTrading ? ' or trading' : ''} ${itemsText}`;

        if (useInBulk && !isTrading) { // Only add in bulk if not trading
             output += ' in bulk';
        }


        const validPrices = items.slice(0, activeItemCount).map(item => item.price && item.price.trim()).filter(price => price);

        let priceSection = `. ${type === 'Buying' ? 'Budget' : 'Price'}: `;

        if (validPrices.length > 0) {
            const priceTexts = validPrices.map((price, index) => {
                const formattedPrice = this.formatClothingPrice(price); // Returns "$4.000", "$4 Million", or "Negotiable"
                const suffix = (items[index].useEach && !isTrading) ? ' each' : ''; // Only add 'each' if not trading
                 return formattedPrice + suffix; // priceText element could be "$4.000 each", "$4 Million", "Negotiable"
            });

            // Join the price texts based on the number of prices and 'respectively'
             if (priceTexts.length === 1) {
                 priceSection += priceTexts[0];
             } else if (isTrading && priceTexts.length === 2) {
                 // Trading prices joined with " and "
                 priceSection += priceTexts.join(' and ');
             } else if (useRespectively && validPrices.length === validItems.length && !isTrading) {
                 // Respectively prices joined with " and " for 2, ", " for more
                 if (priceTexts.length > 2) {
                     const allButLast = priceTexts.slice(0, -1).join(', ');
                     const last = priceTexts[priceTexts.length - 1];
                     priceSection += `${allButLast} and ${last} respectively`;
                 } else {
                     priceSection += priceTexts.join(' and ') + ' respectively';
                 }
            } else { // Multiple prices, not trading, not respectively - joined with ", "
                 priceSection += priceTexts.join(', ');
            }

            output += priceSection;

            // MODIFIED PERIOD LOGIC: Add a final period based on the end of the priceSection
            const priceSectionEnd = priceSection.trimEnd(); // Trim trailing whitespace for accurate checking
             if (priceSectionEnd.endsWith('Negotiable') ||
                 priceSectionEnd.endsWith('Million') ||
                 priceSectionEnd.endsWith(' each') ||
                 priceSectionEnd.endsWith('respectively')) {
                  // Add a period only if the output doesn't already end with one (e.g., from "Negotiable.")
                  if (!output.trimEnd().endsWith('.')) {
                     output += '.';
                  }
            }
             // No period is added if the priceSectionEnd is a purely numerical value (e.g., "$4.000")


        } else {
             output += `. ${type === 'Buying' ? 'Budget' : 'Price'}: Negotiable.`; // Period is already here for Negotiable
        }


            // --- IMPROVED: Ensure output always ends with a period for all cases except raw numbers ---
            // (e.g., "Price: $4.000" should not have a period, but "Price: Negotiable" and "Price: $4 Million" should)
            function ensureFinalPeriod(text) {
                if (text.trim().endsWith('.')) return text.trim();
                if (/\d$/.test(text.trim()) && !text.includes('Million') && !text.includes('Negotiable') && !text.endsWith(' each') && !text.endsWith('respectively')) return text.trim();
                return text.trim() + '.';
            }
            return ensureFinalPeriod(output.trim());
    }

    updatePreview() {
        try {
            if (this.clothingOutput) {
                this.clothingOutput.textContent = this.formatClothingAd();
            }
        } catch (error) {
            console.error('Error in updatePreview:', error);
        }
    }

    handleCopy() {
        const outputText = this.clothingOutput.textContent;
        if (outputText === 'Your clothing advertisement will appear here...') {
            showErrorPopup('Generate an ad first!');
            return;
        }

        navigator.clipboard.writeText(outputText).then(() => {
            showNotification('Copied to clipboard!');
        }).catch(err => {
            showErrorPopup('Failed to copy to clipboard: ' + err);
        });
    }

    resetForm() {
        this.state = {
            type: 'Buying',
            isTrading: false,
            items: [{}, {}, {}],
            activeItemCount: 1,
            useInBulk: false,
            useRespectively: false
        };

        // Reset transaction type radio buttons (assuming 'Buying' is default)
        const defaultTransactionRadio = this.form.querySelector('input[name="clothing-transaction"][value="Buying"]');
        if (defaultTransactionRadio) {
            defaultTransactionRadio.checked = true;
             // Manually trigger change to update active class
             defaultTransactionRadio.dispatchEvent(new Event('change', { bubbles: true }));
        }

        // Reset trading checkbox
        if (this.clothingTradingCheckbox) {
             this.clothingTradingCheckbox.checked = false;
        }

        // Reset in bulk checkbox
        if (this.clothingInBulkInput) {
             this.clothingInBulkInput.checked = false;
              if(this.clothingInBulkLabel) this.clothingInBulkLabel.classList.remove('active');
        }


        // Reset respectively checkbox
        if (this.clothingRespectivelyCheck) {
             const respectivelyInput = this.clothingRespectivelyCheck.querySelector('input[type="checkbox"]');
             if(respectivelyInput) respectivelyInput.checked = false;
              this.clothingRespectivelyCheck.classList.add('d-none'); // Hide it
        }


        this.updateUI(); // Redraw UI with initial state
        this.updatePreview(); // Reset output text
    }
}

document.addEventListener('DOMContentLoaded', () => {
    try {
        // Removed the redundant clothing type select population from here.
        // The selects are created and populated within createClothingInputGroup.

        new ClothingForm();


        // Global click listener to hide suggestion boxes
        document.addEventListener('click', (e) => {
            // Select all elements that are suggestion boxes
            document.querySelectorAll('.suggestion-box').forEach(suggestionBox => {
                // Check if the clicked element is NOT inside the current suggestion box
                // AND is NOT the input field associated with this suggestion box.
                // This requires finding the associated input, which is the previous sibling
                // of the suggestion-box's parent element's previous sibling (the input-group)
                let isClickInsideBox = suggestionBox.contains(e.target);
                let associatedInput = null;

                // Find the input element that is a sibling of the suggestion box's parent div
                // Look for an input with class 'clothing-name-input' within the same item group
                const itemGroup = suggestionBox.closest('.clothing-item-group');
                if (itemGroup) {
                     associatedInput = itemGroup.querySelector('.clothing-name-input');
                }


                if (!isClickInsideBox && (!associatedInput || !associatedInput.contains(e.target))) {
                    suggestionBox.style.display = 'none';
                }
            });
        });
    } catch (error) {
        console.error('Error in clothing DOMContentLoaded:', error);
    }
});

}
